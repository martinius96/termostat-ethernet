<!DOCTYPE html>
<html lang="en">
<head>
  	<meta property="og:title" content="Ethernet - room thermostat - Arduino - Contact" />  	
	<meta name="robots" content="index, follow">
	<link rel="icon" type="image/png" href="favicon.png">
	<link rel="sitemap" type="application/xml" title="Sitemap" href="../../sitemap.xml" />
    	<meta name='revisit-after' content='2 days'>
    	<title>Room thermostat - ESP32 + PHY Ethernet LAN8720</title>
    	<meta property='fb:admins' content='100001242570317'>
    	<meta charset="utf-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
    	<meta name="description" content="Room thermostat designed on the ESP32 platform for heating. Communication via Ethernet">
    	<meta name="keywords" content="thermostat, esp32, lan8720, rmii, phy, ethernet, webserver, ds18b20, temperature, boiler, heating">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	<meta name="google-site-verification" content="UwZZh2EXv3iWUAi_1Z0hLxVCz6ySJ4UdY_BPoLtejwo" />
	<script type="text/javascript">
    		window.smartlook||(function(d) {
    			var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];
    			var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';
    			c.charset='utf-8';c.src='https://rec.smartlook.com/recorder.js';h.appendChild(c);
    		})(document);
    		smartlook('init', 'db50efe9fff280a17db52b82be221240cbbd3dbe');
	</script>    
			<style>
	#right {
  position: absolute;
  right: 0px;
}
	</style>
<style>

.aa_h2{
  font:100 5rem/1 Roboto;
  text-transform: uppercase;
}
table{
   background: #fff;
}
table,thead,tbody,tfoot,tr, td,th{
  text-align: center;
  margin: auto;
  border:1px solid #dedede;
  padding: 1rem;
  width: 50%;
}
.table    { display: table; width: 100%; }
.tr       { display: table-row;  }
.thead    { display: table-header-group }
.tbody    { display: table-row-group }
.tfoot    { display: table-footer-group }
.col      { display: table-column }
.colgroup { display: table-column-group }
.td, .th   { display: table-cell; width: 50%; }
.caption  { display: table-caption }

.table,
.thead,
.tbody,
.tfoot,
.tr,
.td,
.th{
  text-align: center;
  margin: auto;
  padding: 1rem;
}
.table{
  background: #fff;
  margin: auto;
  border:none;
  padding: 0;
  margin-bottom: 5rem;
}

.th{
  font-weight: 700;
  border:1px solid #dedede;
  &:nth-child(odd){
    border-right:none;
  }
}
.td{
  font-weight: 300;
  border:1px solid #dedede;
  border-top:none;
  &:nth-child(odd){
    border-right:none;
  }
}

.aa_htmlTable{
  background: tomato;
  padding: 5rem;
  display: table;
  width: 100%;
  height: 100vh;
  vertical-align: middle;
}
.aa_css{
  background: skyblue;
  padding: 5rem;
  display: table;
  width: 100%;
  height: 100vh;
  vertical-align: middle;
}

.aa_ahmadawais{
  display: table;
  width: 100%;
  font: 100 1.2rem/2 Roboto;
  margin: 5rem auto;
}
    
  </style>
</head>
<body>
	<div class="container">
  		<div class="row">
<div class="col-sm-12">
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="index.html">Thermostat - Ethernet</a>
    </div>
    <ul class="nav navbar-nav">
      	<li><a href="index.html">Overview</a></li>
	<li><a href="zapojenie.html">Involvement</a></li>      
	<li class=""><a href="spustenie.html">Firmware</a></li>
  <li><a href="json_client.html">JSON client</a></li>
      	<li><a href="kontakt.html">Contact</a></li>
<li class="active"><a href="phy_ethernet.html">ESP32 + PHY</a></li>
<a href="../de/phy_ethernet.html"><img src="https://futbalovysen.sk/wp-content/uploads/germany.png" alt="Germany.png, 2,2kB" title="Germany" height="32" width="32"></a>	
<a href="../phy_ethernet.html"><img src="https://futbalovysen.sk/wp-content/uploads/slovakia.png" alt="Slovak flag.png, 2,2kB" title="Slovakia" height="32" width="32"></a>
<li style="float: right; "><a href="https://martinius96.github.io/WiFi-termostat/en/" class="btn btn-success" role="button" title="Change project to WiFi thermostat"><img src="https://www.flaticon.com/premium-icon/icons/svg/3686/3686730.svg" width=16px height=16px> <font color="white">WiFi thermostat</font></a></li></ul>
  </div>
</nav>   	
<div class="alert alert-danger">
 	<strong>Support Ethernet thermostat project via PayPal. Your support will allow me to add new functionalities (async webserver, manual mode, Over-The-Air firmware upload) into firmware that will be distributed to everyone on this webpage: </strong><a href="https://www.paypal.com/paypalme/chlebovec" class="btn btn-primary" role="button">PayPal donate</a>
</div>		
<div class="alert alert-success">
 	<strong>If you are interested in source code for ESP32 + PHY Ethernet thermostat, email me at: </strong>martinius96@gmail.com
</div>	
<span class="label label-default">ESP32</span>
<span class="label label-primary">Ethernet</span>
<span class="label label-success">LAN8720</span>
<span class="label label-info">DS18B20</span>
<span class="label label-warning">OneWire</span>
<span class="label label-danger">Dallas</span>
<span class="label label-default">HTML</span>
<span class="label label-primary">Webserver</span>
<span class="label label-success">WebSocket</span>
<hr><h4>Compatible hardware for PHY Ethernet thermostat:</h4><hr>
<div class="row">
<div class="col-sm-2"><center><img src="https://i.imgur.com/BczG03b.png" width="128px" height="128px" style="border-radius: 50%;" alt="Riadiaci mikrokontróler ESP32 Devkit V1 - ESP-WROOM-32 / ESP32-S" title="Riadiaci mikrokontróler ESP32 Devkit V1 - ESP-WROOM-32 / ESP32-S"><br><b>ESP32 DevKit</b><br></center></div>	
<div class="col-sm-2"><center><img src="https://i.imgur.com/ppyXzMM.png" width="128px" height="128px" style="border-radius: 50%;" alt="Ethernet modul LAN 8720 PHY Ethernet" title="Ethernet modul LAN 8720 PHY Ethernet"><br><b>Ethernet module PHY LAN8720</b><br></center></div>
<div class="col-sm-2"><center><img src="https://i.imgur.com/sMrQ8Es.png" width="128px" height="128px" style="border-radius: 50%;" alt="Teplotný senzor DS18B20 v puzdre TO-92" title="Teplotný senzor DS18B20 v puzdre TO-92"><br><b>Dallas DS18B20 - case TO-92</b><br></center></div>
<div class="col-sm-2"><center><img src="https://i.imgur.com/FNWTjFE.png" width="128px" height="128px" style="border-radius: 50%;" alt="Teplotný senzor DS18B20 - vodotesné vyhotovenie" title="Teplotný senzor DS18B20 - vodotesné vyhotovenie"><br><b>Dallas DS18B20 - for exterior</b><br></center></div>
<div class="col-sm-2"><center><img src="https://i.imgur.com/eMp0SSr.png" width="128px" height="128px" style="border-radius: 50%;" alt="SSR relé OMRON G3MB-202P" title="SSR relé OMRON G3MB-202P"><br><b>SSR relay OMRON G3MB-202P</b><br></center></div>
<div class="col-sm-2"><center><img src="https://i.imgur.com/cqaEQJ7.png" width="128px" height="128px" style="border-radius: 50%;" alt="Elektromagnetické relé SRD-05VDC-SL-C" title="Elektromagnetické relé SRD-05VDC-SL-C"><br><b>Elmg. relay SRD-05VDC-SL-C</b><br></center></div>
</div>			
<hr><center><h1>Room thermostat - ESP32 + LAN8720</h1></center><hr>
<p style="text-align: justify;">
The ESP32 microcontroller is connected to the LAN8720 PHY Ethernet module via the RMII interface. ESP32 provides the MAC layer for the PHY Ethernet via the WiFi controller.
Web server implemented in Arduino Core and allows controlling the thermostat through a browser in the LAN network, where the ESP32 is available at an assigned IP address within the DHCP range.
The thermostat logic is executed regardless of whether the web server web page is open to the client.
Changing the logic and threshold temperatures is done through HTTP requests from clients in the network via an HTML form, or the request can be sent directly through an HTTP POST request with default arguments fname and fname2.
Based on the request for a specific subpage, it is possible to control the output, for example manually / automatically, or it is possible to overwrite the control data with an argument set to a certain value.
They are stored in the emulated EEPROM memory in the flash memory, while the lifetime of this sector is at the level of 10,000 rewrites.
It is possible to control the reference (requested) temperature and hysteresis.
The web server runs on the standard HTTP port - 80.
</p>
<hr>
<p style="text-align: justify;">
Thermostat can automatically control the signaling relay (with inverted logic) for switching the gas boiler ON / OFF via the GPIO output state.
It can thus replace the existing room thermostat and make it available in the LAN network to all clients.
Thermostat can operate on any device with a browser - computer / smartphone / tablet / Smart TV and similar.
<b>As a decision algorithm, a target temperature with hysteresis is used, which is compared with the measured temperature from the Dallas DS18B20 digital temperature sensor.</b>
The target temperature and hysteresis is read from the EEPROM memory, where it is stored permanently even in the event of a power failure and is overwritten when new data is written.
<b>The resolution of the DS18B20 sensor during measurement is 12-bit, which is explained by the temperature resolution of 0.0625 °C, which is the minimum resolution step between different measurements.
Data over the OneWire bus can arrive at the microcontroller upon request in 500 to 1000 ms, depending on the number of sensors on the OneWire bus, the length of the bus, etc...</b>
The decision-making logic of the thermostat is performed every 10 seconds independently of the web application, a keep-alive connection is not required to perform the logic, the system thus works autonomously and does not require the user's attention.
</p>
<b>On the hardware side, the project uses:</b>
<li>ESP32</li>
<li>Ethernet module LAN8720</li>
<li>DS18B20 temperature sensor on the OneWire bus in a TO-92 case, or in a waterproof version in an aluminum tube</li>
<li>Electromagnetic relay SRD-5VDC-SL-C / SSR relay OMRON G3MB-202P used for switching the boiler (Active-LOW signal)</li>
<hr>
<b>Wiring of hardware components:</b>
<center>
<table class="table table-striped flat-table flat-table-3" style="color: black; max-width: 100%;">
<thead>
<tr>
<th style="width: 50%;"><strong>ESP32</strong></th>
<th style="width: 50%;"><strong>Dallas DS18B20</strong></th>
</tr>
<tr>
<td>3V3</td>
<td>Vcc</td>
</tr>
<tr>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>D5</td>
<td>DATA</td>
</tr>
</table>
<table class="table table-striped flat-table flat-table-3" style="color: black; max-width: 100%;">
<thead>
<tr>
<th style="width: 50%;"><strong>ESP32</strong></th>
<th style="width: 50%;"><strong>Relay (OMRON G3MB-202P / SRD-05VDC-SL-C)</strong></th>
</tr>
<tr>
<td>5V</td>
<td>Vcc</td>
</tr>
<tr>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>D4</td>
<td>IN</td>
</tr>
</table>
<table class="table table-striped flat-table flat-table-3" style="color: black; max-width: 100%;">
<thead>
<tr>
<th style="width: 50%;"><strong>ESP32</strong></th>
<th style="width: 50%;"><strong>PHY Ethernet LAN8720</strong></th>
</tr>
<tr>
<td>3V3</td>
<td>Vcc</td>
</tr>
<tr>
<td>GND</td>
<td>GND / RBIAS</td>
</tr>
<tr>
<td>D18</td>
<td>MDIO</td>
</tr>
<tr>
<td>D19</td>
<td>TXD0</td>
</tr>
<tr>
<td>D21</td>
<td>TXEN</td>
</tr>
<tr>
<td>D22</td>
<td>TXD1</td>
</tr>
<tr>
<td>D23</td>
<td>MDC</td>
</tr>
<tr>
<td>D25</td>
<td>RXD0</td>
</tr>
<tr>
<td>D26</td>
<td>RXD1</td>
</tr>
<tr>
<td>D27</td>
<td>CRS_DV</td>
</tr>
</table>
</center> 
<hr>
<p style="text-align: justify;">
<b>HTML webpages running on ESP32 webserver:</b>
<li><b>/</b> - root page containing the form, the current listing of the logic output for the relay, the current and target temperature, the temperature, hysteresis</li>
<li><b>/action.html</b> - processes the values from the form, writes them to the emulated EEPROM memory, redirects the user back to the root page</li>
<li><b>/get_data.json</b> - distributes data about current temperature, reference temperature and hysteresis to a third party (computer, microcontroller, other client...) in JSON format - can be used with an example JSON client that can send data to MQTT Broker, for example to home automation</li>
<li><del><b>/zap.html</b> - permanent activation of the output in manual mode</del><img src="https://i.imgur.com/zMsp0cr.png" width="20px" height="20px" data-toggle="tooltip3" data-placement="right" title="Manual control is NOT included in free version of PHY Ethernet thermostat"></li>
<li><del><b>/vyp.html</b> - permanent shutdown of the output in manual mode</del><img src="https://i.imgur.com/zMsp0cr.png" width="20px" height="20px" data-toggle="tooltip3" data-placement="right" title="Manual control is NOT included in free version of PHY Ethernet thermostat"></li>
<li><del><b>/automat.html</b> - changing the thermostat mode to automatic (uses hysteresis and target temperature)</del><img src="https://i.imgur.com/zMsp0cr.png" width="20px" height="20px" data-toggle="tooltip3" data-placement="right" title="Manual control is NOT included in free version of PHY Ethernet thermostat"></li>
<li><del><b>/manual.html</b> - changing the thermostat mode to manual (permanent control of the GPIO output for boiler status ON / OFF)</del><img src="https://i.imgur.com/zMsp0cr.png" width="20px" height="20px" data-toggle="tooltip3" data-placement="right" title="Manual control is NOT included in free version of PHY Ethernet thermostat"></li>
<hr>				
Electromagnetic relay SRD-5VDC-SL-C, which is used in the project, allows to switch up to 10A at 230V - maximum power 2300W.
In the case of switching a DC circuit (load), it is possible to switch 300W (10A at 30V DC max).
For the wiring diagram, the OMRON G3MB-202P SSR relay is also fully compatible, which is only suitable for non-inductive loads and exclusively for AC voltage loads (the DC circuit cannot open after switching).
Maximum switched power 460W (230V, 2A). <b>The thermostat can be used all year round. In case of unnecessary control, the output can be physically disconnected and the thermostat can be used as an Ethernet thermometer to obtain data from the room where it is located.</b>
</p>

<b>Web interface for Ethernet thermostat enables:</b>
<li>View in real time the temperature from the DS18B20 sensor on the OneWire bus, device uptime, output status with dynamic change, currently set configuration data for the thermostat, i.e. target temperature and hysteresis from EEPROM</li>
<li>Modify the target (reference) temperature <del> in the range 5 to 50 °C with 0.25 °C steps</del><img src="https://i.imgur.com/zMsp0cr.png" width="20px" height="20px" data-toggle="tooltip2" data-placement="right" title="Range removed in version 1.0.2 due to non-support of decimal point for input type number on Android OS"></li>
<li>Modify hysteresis <del> in the range 0 to 10 °C in 0.25 °C steps</del><img src="https://i.imgur.com/zMsp0cr.png" width="20px" height="20px" data-toggle="tooltip2" data-placement="right" title="Range removed in version 1.0.2 due to non-support of decimal point for input type number on Android OS"></li>

<b>ON/OFF boiler regulation:</b>
<li>Example ON/OFF heating regulation - <font color="red">VISUALIZATION IS NOT PART OF THE PROJECT</font></li>
<li>The boiler is active until the target temperature + hysteresis is reached</li>
<li>The visualization of water temperatures shows the so-called heating run-up and subsequent cooling of the water until heating is reactivated, when the measured temperature is below the set target temperature - hysteresis</li>
<img src="https://i.imgur.com/IDWLuOr.png" style="display: block; max-width: 100%; height: auto;" alt="ZAP/VYP regulácia kotla s hysterézou" title="ZAP/VYP regulácia kotla s hysterézou">        			    
<p style="text-align: justify;">
The web interface is designed to adapt to larger and smaller screens. It is responsive, supports high-resolution widescreens, but also mobile devices.
The interface uses imported Bootstrap framework CSS styles from an external CDN server, which loads the client-side device when opening a page running on ESP32.
In order for the set values of the thermostat to be preserved even after a power failure, they are stored in the ESP's EEPROM memory, which is emulated in flash memory, since the platform does not physically have an EEPROM chip (memory).
Reference temperature at offset 10, hysteresis at offset 100. Each value occupies a maximum of 5B in EEPROM memory + terminating character.
The data is overwritten only when the HTML form is sent, the operation of the thermostat is thus maximally gentle on the EEPROM memory for its maximum durability.
The state of the output exists only in the RAM memory, where it is overwritten when changed. The value is not stored in the emulated EEPROM memory in the flash memory.
</p>
<hr>
<p style="text-align: justify;">
By means of the Refresh meta tag, the web server refreshes the entire page every 30 seconds, and an approximate refresh time is also written to the HTML page via Javascript.
It is necessary to write down the change for the thermostat by this time, otherwise the input windows for numerical inputs to the form will be reset when the page is refreshed. <b>Based on feedback from Android device users, the Refresh time has been extended from 10 to 30 seconds.</b>
The dynamic data that primarily changes is the current value of the output - <b><font color="#27AE60">ON</font></b> / <b><font color="red">OFF</font> </b>, which informs the operator about the actual state of the output together with the color marking.
As the logic of the system is executed independently of the web server, the output may already be in a different state than the one currently displayed in the web application before the refresh. The output change is immediately printed, for example, on the UART monitor (115200 baud/s).
On the website of the thermostat, the user can also find information about the uptime of the device (how long it runs), i.e. time in days, hours, minutes and seconds.
</p>
<div class="alert alert-danger">
	<strong>The author of the Ethernet thermostat is not responsible for the functionality of the thermostat, boiler failure, electric shock due to improper installation of the thermostat in the network.</strong>
</div>	
<b>Main page for modification of target temperature and hysteresis - preview of switched on output:</b>
<div class="alert alert-info">
	<strong>Sample data</strong>
	<li><b>Target temperature:</b> 22.75 °C</li>
	<li><b>Hysteresis:</b> 0.25 °C</li>
	<li><b>Measured data:</b> 22.49 °C</li>
	<li><b>Output:</b>  <font color="#27AE60">ON</font></li>
	<hr>
	<p style="text-align: justify;">
		The thermostat heats from a measured temperature of 22.49 °C and below.
If the temperature reaches 23.01 °C and higher, the output is switched off, the signaling relay is disconnected and the gas boiler stops heating.
The heating and cooling of the room in which the measurements are performed takes place.
The thermostat is activated again only when the temperature reaches 22.49 °C or lower.
	</p>	
</div>
<center>
<hr>
<h4>Fully functional Ethernet thermostat with the option of setting data controls:</h4>
<hr>
</center>
<div class="alert alert-info">
	<strong>Refresh the web interface automatically every 30 seconds</strong>
</div>	
<b>Main control webpage of Ethernet PHY thermostat - output ON:</b>
<img src="https://i.imgur.com/MFYjguV.png" style="display: block; max-width: 100%; height: auto;" alt="PHY Ethernet termostat ESP32 - Main webpage with output off" title="PHY Ethernet termostat ESP32 - Main webpage with output off">        			

<b>Processing progress of entered data (user redirection):</b>
<img src="https://i.imgur.com/hVVGnXP.png" style="display: block; max-width: 100%; height: auto;" alt="PHY Ethernet termostat ESP32 - Processing progress of entered data in HTML form" title="PHY Ethernet termostat ESP32 - Processing progress of entered data in HTML form">        			

<b>JSON output of the webserver in the browser / client via websocket:</b>
<center><img src="https://i.imgur.com/tRcuvnr.png" style="display: block; max-width: 100%; height: auto;" alt="PHY Ethernet termostat ESP32 - JSON output" title="PHY Ethernet termostat ESP32 - JSON output"></center>        		

<b>Output to UART monitor - system logic + set IP address:</b>
<center>
<img src="https://i.imgur.com/q1uvK3d.png" style="display: block; max-width: 100%; height: auto;" alt="PHY Ethernet termostat ESP32 - cyclic output with IP address, current temperature and GPIO output status" title="PHY Ethernet termostat ESP32 - cyclic output with IP address, current temperature and GPIO output status">
</center>        		
<hr><center><h4>Available libraries for microcontrollers (ESP32)</h4></center><hr>
<div class="alert alert-danger">
	Unzip the library archive (.zip) to <strong>C:/Users/[USER]/Documents/Arduino/libraries</strong>
</div>
<div class="table-responsive">   
<table class="table" style="border: 1px solid black;">
<thead>
<tr>
<th style="width: 25%">Library name</th>
<th style="width: 50%">Library function</th>
<th style="width: 25%">Download</th>
</tr>
</thead>
<tbody>
<tr>
<td style="width: 25%"><b>Dallas</b></td>
<td style="width: 50%">
<p style="text-align: justify;">
Library for Espressif Systems microcontrollers (ESP32).
It enables communication with the Dallas DS18B20 sensor on the OneWire bus. Possibility of communication after normal or parasitic connection. 
</p>
</td>
<td style="width: 25%"><a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/martinius96/termostat-ethernet/tree/master/src/dallas" class="btn btn-success" role="button">Download</a></td>
</tr>
</tbody>
</table>
	</div>
<hr>
<h3 style="display: none;"><font color="#2ECC71">Source code - Ethernet thermostat - ESP32 + PHY LAN8720 - DHCP</font></h3>	
<pre style="background-color:#2ECC71;">
/*|-----------------------------------------------------------|*/
/*|HTTP webserver - Ethernet thermostat - ESP32 + PHY LAN8720 |*/
/*|Project webpage:                                           |*/
/*|https://martinius96.github.io/termostat-ethernet/en        |*/
/*|AUTHOR: Martin Chlebovec                                   |*/
/*|EMAIL: martinius96@gmail.com                               |*/
/*|-----------------------------------------------------------|*/

#include &lt;ETH.h>
#include &lt;WebServer.h>
WebServer server(80);

#include &lt;EEPROM.h>
#include &lt;OneWire.h>
#include &lt;DallasTemperature.h>

#define ONE_WIRE_BUS 5 //D5
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensorsA(&oneWire);
const int rele = 4; //D4
unsigned long time_running = 0;
String state = "OFF";
float temperature;
long day = 86400000; // 86400000 milliseconds in a day
long hour = 3600000; // 3600000 milliseconds in an hour
long minute = 60000; // 60000 milliseconds in a minute
long second =  1000; // 1000 milliseconds in a second

#ifdef ETH_CLK_MODE
#undef ETH_CLK_MODE
#endif
#define ETH_CLK_MODE    ETH_CLOCK_GPIO17_OUT

// Pin# of the enable signal for the external crystal oscillator (-1 to disable for internal APLL source)
#define ETH_POWER_PIN   -1

// Type of the Ethernet PHY (LAN8720 or TLK110)
#define ETH_TYPE        ETH_PHY_LAN8720

// I²C-address of Ethernet PHY (0 or 1 for LAN8720, 31 for TLK110)
#define ETH_ADDR        1

// Pin# of the I²C clock signal for the Ethernet PHY, DONT USE THIS PIN FOR ultrasonic sensor in this sketch
#define ETH_MDC_PIN     23

// Pin# of the I²C IO signal for the Ethernet PHY
#define ETH_MDIO_PIN    18

void WiFiEvent(WiFiEvent_t event)
{
  switch (event) {
    case ARDUINO_EVENT_ETH_START:
      Serial.println("ETH Started");
      //set eth hostname here
      ETH.setHostname("esp32-ethernet");
      break;
    case ARDUINO_EVENT_ETH_CONNECTED:
      Serial.println("ETH Connected");
      break;
    case ARDUINO_EVENT_ETH_GOT_IP:
      Serial.print("ETH MAC: ");
      Serial.print(ETH.macAddress());
      Serial.print(", IPv4: ");
      Serial.print(ETH.localIP());
      if (ETH.fullDuplex()) {
        Serial.print(", FULL_DUPLEX");
      }
      Serial.print(", ");
      Serial.print(ETH.linkSpeed());
      Serial.println("Mbps");
      break;
    case ARDUINO_EVENT_ETH_DISCONNECTED:
      Serial.println("ETH Disconnected");
      break;
    case ARDUINO_EVENT_ETH_STOP:
      Serial.println("ETH Stopped");
      break;
    default:
      break;
  }
}

boolean isFloat(String tString) {
  String tBuf;
  boolean decPt = false;

  if (tString.charAt(0) == '+' || tString.charAt(0) == '-') tBuf = &tString[1];
  else tBuf = tString;

  for (int x = 0; x &lt; tBuf.length(); x++)
  {
    if (tBuf.charAt(x) == '.' || tBuf.charAt(x) == ',') {
      if (decPt) return false;
      else decPt = true;
    }
    else if (tBuf.charAt(x) &lt; '0' || tBuf.charAt(x) > '9') return false;
  }
  return true;
}

void writeString(char add, float data)
{
  EEPROM.put(add, (data * 1000));
  EEPROM.commit();
}


float read_String(char add)
{
  float payload = 0;
  float data = EEPROM.get(add, payload);
  return (data / 1000);
}

void handleRoot() {
  int days = millis() / day ;                                //number of days
  unsigned int hours = (millis() % day) / hour;                       //the remainder from days division (in milliseconds) divided by hours, this gives the full hours
  unsigned int minutes = ((millis() % day) % hour) / minute ;         //and so on...
  unsigned int seconds = (((millis() % day) % hour) % minute) / second;
  String page = F("&lt;!DOCTYPE html>");
  page += F("&lt;html>");
  page += F("&lt;head>");
  page += F("&lt;meta charset='utf-8'>");
  page += F("&lt;meta name='author' content='Martin Chlebovec'>");
  page += F("&lt;meta http-equiv='Refresh' content='30'; />");
  page += F("&lt;meta name='viewport' content='width=device-width, initial-scale=1'>");
  page += F("&lt;link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css'>");
  page += F("&lt;script type='text/javascript'>");
  page += F("var timeleft = 30;");
  page += F("var downloadTimer = setInterval(function(){");
  page += F("if(timeleft &lt;= 0){");
  page += F("clearInterval(downloadTimer);");
  page += F("document.getElementById(\"countdown\").innerHTML = \"Refreshing...\";");
  page += F("} else {");
  page += F("document.getElementById(\"countdown\").innerHTML = timeleft + \" seconds to refresh\";");
  page += F("}");
  page += F("timeleft -= 1;");
  page += F("}, 1000);");
  page += F("&lt;/script>");
  page += F("&lt;title>Ethernet thermostat - ESP32 + PHY Ethernet&lt;/title>");
  page += F("&lt;/head>");
  page += F("&lt;body>");
  page += F("&lt;center>&lt;h3>Enter datas for web server:&lt;/h3>");
  page += F("&lt;form action='/action.html' method='post'>");
  page += "&lt;b>Target temperature:&lt;/b>&lt;br>&lt;input type='text' id='fname' name='fname' min='5' max='50' step='0.25' value=" + String(read_String(10)) + ">&lt;br>";
  page += "&lt;b>Hysteresis:&lt;/b>&lt;br>&lt;input type='text' id='fname2' name='fname2' min='0' max='10' step='0.25' value=" + String(read_String(100)) + ">&lt;br>";
  page += F("&lt;input type='submit' class='btn btn-success' value='Send'>");
  page += F("&lt;/form>&lt;hr>");
  if (state == "ON") {
    page += F("&lt;b>&lt;font color='green'>Output: ON&lt;/font>&lt;/b>");
  }
  if (state == "OFF") {
    page += F("&lt;b>&lt;font color='red'>Output: OFF&lt;/font>&lt;/b>");
  }
  page += F("&lt;div id=\"countdown\">&lt;/div>");
  page += F("&lt;b>Current sensor DS18B20 temperature:&lt;/b> ");
  page += String(temperature);
  page += F(" °C");
  page += F("&lt;hr>");
  page += F("&lt;b>Uptime: &lt;/b>");
  page += String(days);
  page += F("d");
  page += F(" ");
  page += String(hours);
  page += F("h");
  page += F(" ");
  page += String(minutes);
  page += F("m");
  page += F(" ");
  page += String(seconds);
  page += F("s");
  page += F("&lt;h3>Author: Martin Chlebovec - martinius96@gmail.com - https://martinius96.github.io/termostat-ethernet/en/&lt;/h3>");
  page += F("&lt;h4>Free version - 1.0.4 build: 22. Aug. 2022&lt;/h4>");
  page += F("&lt;/center>");
  page += F("&lt;/body>");
  page += F("&lt;/html>");
  server.send(200, "text/html", page);
}

void handleBody() {
  if (server.hasArg("fname")) {
    String target_temp = server.arg("fname");
    // float target_temperature = target_temp.toFloat();

    if (isFloat(target_temp)) {
      float target_temperature = target_temp.toFloat();
      writeString(10, target_temperature);
    } else {
      Serial.println(F("No number was entered in the target temperature input field!"));
      Serial.println(F("Datas will be not stored in EEPROM!"));
    }
  }
  if (server.hasArg("fname2")) {
    String hysteresis = server.arg("fname2");
    if (isFloat(hysteresis)) {
      float hysteresis = hysteresis.toFloat();
      writeString(100, hysteresis);
    } else {
      Serial.println(F("No number was entered in the hysteresis input field!"));
      Serial.println(F("Datas will be not stored in EEPROM!"));
    }
  }
  String page = F("&lt;!DOCTYPE html>");
  page += F("&lt;html>");
  page += F("&lt;head>");
  page += F("&lt;meta charset='utf-8'>");
  page += F("&lt;meta http-equiv='Refresh' content='5; url=/' />");
  page += F("&lt;title>Ethernet thermostat - ESP32 - data processing&lt;/title>");
  page += F("&lt;/head>");
  page += F("&lt;body>");
  page += F("&lt;center>&lt;h3>Server received datas from HTML form:&lt;/h3>");
  page += "&lt;li>&lt;b>Target temperature: &lt;/b>" + String(read_String(10)) + " °C&lt;/li>";
  page += "&lt;li>&lt;b>Hysteresis: &lt;/b>" + String(read_String(100)) + " °C&lt;/li>";
  page += F("&lt;b>Redirecting... Please wait&lt;/b>&lt;/center>");
  page += F("&lt;/body>");
  page += F("&lt;/html>");
  server.send(200, "text/html", page);
}

void handleGet() {
  String page = "{\n";
  page += F("\"Hysteresis\":");
  page += String(read_String(100));
  page += F(",\n");
  page += F("\"Target_Temperature\":");
  page += String(read_String(10));
  page += F(",\n");
  page += F("\"Actual_Temperature\":");
  page += String(temperature) + "\n";
  page += F("}\n");
  server.send(200, "application/json", page);
}

void setup() {
  Serial.begin(115200);
  WiFi.onEvent(WiFiEvent);
  ETH.begin(ETH_ADDR, ETH_POWER_PIN, ETH_MDC_PIN, ETH_MDIO_PIN, ETH_TYPE, ETH_CLK_MODE);
  EEPROM.begin(512);  //Initialize EEPROM
  float a = read_String(10);
  float b = read_String(100);
  if (isnan(a)) {
    writeString(10, 20.25);
  }
  if (isnan(b)) {
    writeString(100, 0.25);
  }
  sensorsA.begin();
  pinMode(rele, OUTPUT);
  digitalWrite(rele, HIGH);
  sensorsA.requestTemperatures();
  delay(750);
  Serial.println(F("Webapp created by: Martin Chlebovec"));
  Serial.println(F("Build 1.0.4 from 22. Aug. 2022"));
  Serial.println(F("IP address of Ethernet thermostat: "));
  Serial.print(ETH.localIP());
  server.on("/", handleRoot);
  server.on("/get_data.json", handleGet);
  server.on("/action.html", HTTP_POST, handleBody);
  server.begin();
}

void loop() {
  if ((millis() - time_running) >= 10000 || time_running == 0) {
    time_running = millis();
    temperature = sensorsA.getTempCByIndex(0);
    Serial.println();
    Serial.println(F("----------------------------------------------"));
    Serial.println(F("IP address of Ethernet thermostat: "));
    Serial.print(ETH.localIP());
    Serial.print(F(", to access Ethernet thermostat, visit http://"));
    Serial.print(ETH.localIP());
    Serial.println(F("/"));
    Serial.print(F("Free HEAP: "));
    Serial.print(ESP.getFreeHeap());
    Serial.println(F(" B"));
    Serial.print(F("Current temperature: "));
    Serial.print(String(temperature));
    Serial.println(F(" °C"));
    sensorsA.requestTemperatures();
    float target_temperature = read_String(10);
    float  hysteresis = read_String(100);
    float minus_hysteresis_temperature = (-1 * hysteresis);
    float difference_temps = target_temperature - temperature; //21 - 20
    if (difference_temps > hysteresis) {
      Serial.println(F("Output on"));
      state = "ON";
      digitalWrite(rele, LOW);
    } else if (difference_temps &lt; minus_hysteresis_temperature) {
      Serial.println(F("Output off"));
      state = "OFF";
      digitalWrite(rele, HIGH);
    } else {
      Serial.println(F("Difference between target and actual temp is not above or below the hysteresis. The output state does not change."));
      Serial.print(F("Actual state of output: "));
      Serial.println(state);
    }
  }
  server.handleClient();
  yield();
}
</pre>
<p style="text-align: justify;"> 
The implementation includes a program for a dynamic IPv4 address assigned to the Ethernet PHY of the thermostat.
<b>The thermostat is intended only for indoor temperatures!</b> (above 0°C), to which the logic of the system is also adapted!
The thermostat can be used to replace an existing room thermostat, or to temporarily replace a heater in an aquarium / terrarium to maintain a constant temperature.
</p>	
</div>				
</div>
					</div>
</body>
</html>
